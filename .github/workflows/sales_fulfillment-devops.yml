name: sales_fulfillment-devops

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

env:
  ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
  ARM_SALES_SUBSCRIPTION_ID: ${{ secrets.AZURE_SALES_SUBSCRIPTION_ID }}
  TF_STATE_RG: rg-root-iac
  TF_STATE_STORAGE_ACCOUNT: storerootblob
  ACR_NAME: acra10corpsales

jobs:
  validate-and-test:
    runs-on: ubuntu-latest
    environment: dev
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r src/backend/requirements.txt
        pip install -r src/frontend/requirements.txt
        pip install -r requirements-dev.txt

    - name: Linting (Ruff)
      run: ruff check .

    - name: Security Check (Bandit)
      run: bandit -r src

    - name: Backend Unit Tests
      env:
        PYTHONPATH: .
        DATABASE_URL: sqlite:///test.db
      run: pytest -s --cov=src/backend tests/backend

    - name: Frontend Unit Tests
      env:
        PYTHONPATH: .
      run: pytest -s --cov=src/frontend tests/frontend

    - name: Azure Login
      uses: azure/login@v1
      with:
        client-id: ${{ vars.AZURE_CLIENT_ID }}
        tenant-id: ${{ vars.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Plan (Dev)
      working-directory: infra/terraform/environments/dev
      run: |
        terraform init \
          -backend-config="resource_group_name=$TF_STATE_RG" \
          -backend-config="storage_account_name=$TF_STATE_STORAGE_ACCOUNT" \
          -backend-config="container_name=workloads-dev" \
          -backend-config="key=sales-fulfillment.tfstate"
        terraform plan -no-color

  e2e-integration-kind:
    runs-on: ubuntu-latest
    needs: validate-and-test
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install Test Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest playwright pytest-playwright
          playwright install chromium
          playwright install-deps chromium

      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1.9.0
        with:
          cluster_name: kind-dev

      - name: Build Docker Images
        run: |
          docker build -t sales-frontend:local -f src/frontend/Dockerfile src/frontend
          docker build -t sales-backend:local -f src/backend/Dockerfile src/backend

      - name: Load Images into Kind
        run: |
          kind load docker-image sales-frontend:local --name kind-dev
          kind load docker-image sales-backend:local --name kind-dev

      - name: Install Helm Chart
        run: |
          helm install sales-app ./charts/sales-fulfillment \
            --namespace sales-fulfillment \
            --create-namespace \
            --set backend.image.repository=sales-backend \
            --set backend.image.tag=local \
            --set backend.image.pullPolicy=Never \
            --set frontend.image.repository=sales-frontend \
            --set frontend.image.tag=local \
            --set frontend.image.pullPolicy=Never \
            --set global.environment=local

      - name: Wait for Pods to be Ready
        run: |
          kubectl wait --namespace sales-fulfillment \
            --for=condition=ready pod \
            --selector=app=frontend \
            --timeout=180s

      - name: Port Forward Frontend
        run: |
          kubectl port-forward svc/frontend 5003:80 -n sales-fulfillment &
          # Wait for port-forward to be active
          for i in {1..10}; do
            if curl -s http://localhost:5003 > /dev/null; then
              echo "Port forward successful"
              exit 0
            fi
            echo "Waiting for port-forward..."
            sleep 2
          done
          echo "Port forward failed"
          exit 1

      - name: Run E2E Tests (Playwright)
        run: |
          BASE_URL="http://localhost:5003" PYTHONPATH=. pytest tests/e2e/test_ui_flow.py

  deploy-stage:
    runs-on: ubuntu-latest
    needs: e2e-integration-kind
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: stage
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Apply (Stage)
        id: tf-apply
        working-directory: infra/terraform/environments/stage
        run: |
          terraform init \
            -backend-config="resource_group_name=$TF_STATE_RG" \
            -backend-config="storage_account_name=$TF_STATE_STORAGE_ACCOUNT" \
            -backend-config="container_name=workloads-stage" \
            -backend-config="key=sales-fulfillment.tfstate"
          terraform apply -auto-approve
          echo "db_url=$(terraform output -raw database_url)" >> $GITHUB_OUTPUT

      - name: ACR Login
        run: az acr login --name $ACR_NAME

      - name: Build and Push Images
        run: |
          docker build -t $ACR_NAME.azurecr.io/sales-frontend:${{ github.sha }} -f src/frontend/Dockerfile src/frontend
          docker build -t $ACR_NAME.azurecr.io/sales-backend:${{ github.sha }} -f src/backend/Dockerfile src/backend
          docker push $ACR_NAME.azurecr.io/sales-frontend:${{ github.sha }}
          docker push $ACR_NAME.azurecr.io/sales-backend:${{ github.sha }}

      - name: Get AKS Credentials
        run: az aks get-credentials --resource-group rg-a10corp-sales-stage --name aks-a10corp-sales-stage --subscription $ARM_SALES_SUBSCRIPTION_ID

      - name: Deploy to AKS (Stage)
        run: |
          helm upgrade --install sales-app ./charts/sales-fulfillment \
            --namespace sales-fulfillment-stage \
            --create-namespace \
            -f ./charts/sales-fulfillment/values-stage.yaml \
            --set backend.image.repository=$ACR_NAME.azurecr.io/sales-backend \
            --set backend.image.tag=${{ github.sha }} \
            --set backend.env.databaseUrl="${{ steps.tf-apply.outputs.db_url }}" \
            --set frontend.image.repository=$ACR_NAME.azurecr.io/sales-frontend \
            --set frontend.image.tag=${{ github.sha }} \
            --set frontend.env.backendUrl="http://backend.sales-fulfillment-stage.svc.cluster.local" \
            --set global.environment=stage

      - name: Run E2E Tests on Stage
        run: |
          python -m pip install pytest playwright pytest-playwright
          playwright install chromium
          
          echo "Waiting for Stage External IP..."
          for i in {1..15}; do
            IP=$(kubectl get svc frontend -n sales-fulfillment-stage -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
            if [ -n "$IP" ]; then
              echo "Stage URL: http://$IP"
              BASE_URL="http://$IP" PYTHONPATH=. pytest tests/e2e/test_ui_flow.py
              exit 0
            fi
            echo "Still waiting for IP (attempt $i)..."
            sleep 10
          done
          echo "Timed out waiting for Stage External IP"
          exit 1

  deploy-prod-green:
    runs-on: ubuntu-latest
    needs: deploy-stage
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: prod
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Apply (Prod)
        id: tf-apply
        working-directory: infra/terraform/environments/prod
        run: |
          terraform init \
            -backend-config="resource_group_name=$TF_STATE_RG" \
            -backend-config="storage_account_name=$TF_STATE_STORAGE_ACCOUNT" \
            -backend-config="container_name=workloads-prod" \
            -backend-config="key=sales-fulfillment.tfstate"
          terraform apply -auto-approve
          echo "db_url=$(terraform output -raw database_url)" >> $GITHUB_OUTPUT

      - name: ACR Login
        run: az acr login --name $ACR_NAME

      - name: Get AKS Credentials
        run: az aks get-credentials --resource-group rg-a10corp-sales-prod --name aks-a10corp-sales-prod --subscription $ARM_SALES_SUBSCRIPTION_ID

      - name: Deploy Green Version
        run: |
          helm upgrade --install sales-app-green ./charts/sales-fulfillment \
            --namespace sales-fulfillment-prod \
            --create-namespace \
            -f ./charts/sales-fulfillment/values-prod.yaml \
            --set backend.image.repository=$ACR_NAME.azurecr.io/sales-backend \
            --set backend.image.tag=${{ github.sha }} \
            --set backend.env.databaseUrl="${{ steps.tf-apply.outputs.db_url }}" \
            --set frontend.image.repository=$ACR_NAME.azurecr.io/sales-frontend \
            --set frontend.image.tag=${{ github.sha }} \
            --set frontend.env.backendUrl="http://backend.sales-fulfillment-prod.svc.cluster.local" \
            --set global.environment=prod
